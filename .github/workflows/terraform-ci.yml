name: Terraform CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-validation:
    name: Validate Terraform Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Initialize Terraform (Modules)
        run: |
          cd terraform/modules/networking
          terraform init -backend=false
          cd ../compute
          terraform init -backend=false
          cd ../storage
          terraform init -backend=false
      
      - name: Validate Networking Module
        run: |
          cd terraform/modules/networking
          terraform validate
      
      - name: Validate Compute Module
        run: |
          cd terraform/modules/compute
          terraform validate
      
      - name: Validate Storage Module
        run: |
          cd terraform/modules/storage
          terraform validate
      
      - name: Initialize Terraform (Dev Environment)
        run: |
          cd terraform/environments/dev
          terraform init -backend=false
      
      - name: Validate Dev Environment
        run: |
          cd terraform/environments/dev
          terraform validate
      
      - name: Terraform Plan (Dry Run)
        run: |
          cd terraform/environments/dev
          terraform plan -var-file=terraform.tfvars.example
        continue-on-error: true
      
      - name: Comment Format Issues
        if: steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ Terraform formatting check failed. Please run `terraform fmt -recursive` to fix.'
            })

  security-scan:
    name: Security Scan with tfsec
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: true
          
  terraform-docs:
    name: Update Terraform Docs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      
      - name: Generate Terraform Docs
        uses: terraform-docs/gh-actions@v1.0.0
        with:
          working-dir: terraform/modules/networking
          output-file: README.md
          output-method: inject
          fail-on-diff: false
